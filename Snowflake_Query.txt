-- 1. Create a dedicated Warehouse (Compute)
CREATE WAREHOUSE IF NOT EXISTS DS_ADMIN_WH 
WITH WAREHOUSE_SIZE = 'XSMALL' 
AUTO_SUSPEND = 60 
AUTO_RESUME = TRUE;

-- 2. Create the Database and Schema
CREATE DATABASE IF NOT EXISTS DS_GROUP_DB;
CREATE SCHEMA IF NOT EXISTS DS_GROUP_DB.ADMIN_PORTAL;

USE SCHEMA DS_GROUP_DB.ADMIN_PORTAL;


CREATE TABLE IF NOT EXISTS DIM_USERS (
    USER_ID STRING PRIMARY KEY,
    FULL_NAME STRING,
    EMAIL STRING UNIQUE,
    DEPARTMENT STRING,     -- e.g., 'F&B', 'Hospitality'
    BRAND_ACCESS STRING,   -- e.g., 'CATCH', 'PULSE', or 'ALL' for Super Admin
    IS_ACTIVE BOOLEAN DEFAULT TRUE,
    CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);


CREATE TABLE IF NOT EXISTS DIM_ROLES (
    ROLE_NAME STRING PRIMARY KEY, -- e.g., 'REGIONAL_MANAGER', 'SUPER_ADMIN'
    CAN_EDIT_USERS BOOLEAN DEFAULT FALSE,
    CAN_DELETE_DATA BOOLEAN DEFAULT FALSE,
    CAN_VIEW_REPORTS BOOLEAN DEFAULT TRUE,
    CAN_MANAGE_ROLES BOOLEAN DEFAULT FALSE
);


CREATE TABLE IF NOT EXISTS USER_ROLE_MAPPING (
    USER_ID STRING REFERENCES DIM_USERS(USER_ID),
    ROLE_NAME STRING REFERENCES DIM_ROLES(ROLE_NAME),
    PRIMARY KEY (USER_ID, ROLE_NAME)
);


CREATE TABLE IF NOT EXISTS AUDIT_LOGS (
    LOG_ID NUMBER AUTOINCREMENT START 1 INCREMENT 1,
    EVENT_TIMESTAMP TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    ADMIN_EMAIL STRING,
    ACTION_TYPE STRING,    -- e.g., 'USER_DEACTIVATED', 'ROLE_CHANGED'
    TARGET_OBJECT STRING,  -- e.g., 'User: John Doe'
    DETAILS VARIANT        -- Stores JSON of the change for deep tracking
);


-- 1. Insert the Super Admin User
INSERT INTO DIM_USERS (USER_ID, FULL_NAME, EMAIL, DEPARTMENT, BRAND_ACCESS)
VALUES ('DS_001', 'Abhay Dubey', 'dubeyabhay430@gmail.com', 'IT_ADMIN', 'ALL');

-- 2. Define the Super Admin Role with all permissions set to TRUE
INSERT INTO DIM_ROLES (ROLE_NAME, CAN_EDIT_USERS, CAN_DELETE_DATA, CAN_VIEW_REPORTS, CAN_MANAGE_ROLES)
VALUES ('SUPER_ADMIN', TRUE, TRUE, TRUE, TRUE);

-- 3. Map Abhay to the Super Admin Role
INSERT INTO USER_ROLE_MAPPING (USER_ID, ROLE_NAME)
VALUES ('DS_001', 'SUPER_ADMIN');

-- 4. (Optional) Log the setup in Audit Logs
INSERT INTO AUDIT_LOGS (ADMIN_EMAIL, ACTION_TYPE, TARGET_OBJECT, DETAILS)
SELECT 'SYSTEM', 'INITIAL_SETUP', 'User: Abhay Dubey', OBJECT_CONSTRUCT('status', 'Success', 'Role', 'SUPER_ADMIN');





SELECT 
    U.FULL_NAME, 
    U.EMAIL, 
    R.ROLE_NAME, 
    R.CAN_EDIT_USERS, 
    R.CAN_MANAGE_ROLES
FROM DIM_USERS U
JOIN USER_ROLE_MAPPING M ON U.USER_ID = M.USER_ID
JOIN DIM_ROLES R ON M.ROLE_NAME = R.ROLE_NAME
WHERE U.EMAIL = 'dubeyabhay430@gmail.com';



select * from  DIM_USERS;
SELECT * FROM AUDIT_LOGS;


GRANT USAGE ON DATABASE DS_GROUP_DB TO ROLE ACCOUNTADMIN;
GRANT USAGE ON SCHEMA DS_GROUP_DB.ADMIN_PORTAL TO ROLE ACCOUNTADMIN;
GRANT SELECT ON ALL TABLES IN SCHEMA DS_GROUP_DB.ADMIN_PORTAL TO ROLE ACCOUNTADMIN;



CREATE OR REPLACE TABLE AUDIT_LOGS (
    ADMIN_EMAIL STRING,
    ACTION_TYPE STRING,
    ACTION_DETAILS STRING, -- Ensure this matches exactly
    EVENT_TIMESTAMP TIMESTAMP_NTZ
);


ALTER TABLE DIM_USERS ADD COLUMN PASSWORD STRING;





ALTER TABLE DIM_USERS ADD COLUMN IF NOT EXISTS PASSWORD STRING;
UPDATE DIM_USERS 
SET PASSWORD = 'Abhay@2004', IS_ACTIVE = TRUE 
WHERE LOWER(EMAIL) = 'dubeyabhay430@gmail.com';
SELECT EMAIL, PASSWORD, IS_ACTIVE FROM DIM_USERS;




-- 1. Ensure columns exist
ALTER TABLE DIM_USERS ADD COLUMN IF NOT EXISTS PASSWORD STRING;
ALTER TABLE DIM_USERS ADD COLUMN IF NOT EXISTS IS_ACTIVE BOOLEAN DEFAULT TRUE;

-- 2. Make sure your new users are actually ACTIVE
UPDATE DIM_USERS SET IS_ACTIVE = TRUE WHERE IS_ACTIVE IS NULL;

-- 3. Check your data - if PASSWORD is NULL for a user, they CANNOT login
SELECT EMAIL, PASSWORD, IS_ACTIVE FROM DIM_USERS;




-- 1. Ensure columns exist and are not ambiguous
ALTER TABLE DIM_USERS ADD COLUMN IF NOT EXISTS PASSWORD STRING;
ALTER TABLE DIM_USERS ADD COLUMN IF NOT EXISTS IS_ACTIVE BOOLEAN DEFAULT TRUE;

-- 2. Clean up any existing records to be Active
UPDATE DIM_USERS SET IS_ACTIVE = TRUE WHERE IS_ACTIVE IS NULL;

-- 3. Update your own password for testing
UPDATE DIM_USERS SET PASSWORD = 'Abhay@2004' WHERE LOWER(EMAIL) = 'dubeyabhay430@gmail.com';



SELECT * FROM DIM_USERS;
SELECT * FROM AUDIT_LOGS;

UPDATE DIM_USERS SET IS_ACTIVE = TRUE WHERE IS_ACTIVE IS NULL;

CREATE OR REPLACE TABLE AUDIT_LOGS (
    AUDIT_ID INT AUTOINCREMENT,
    ACTION_TYPE STRING,
    ACTION_DETAILS STRING,
    ACTION_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    CHANGED_BY STRING,
    HOST_IP STRING,
    HOST_NAME STRING
);




-- Main Users Table
CREATE OR REPLACE TABLE DIM_USERS (
    USER_ID STRING PRIMARY KEY,
    FULL_NAME STRING,
    EMAIL STRING UNIQUE,
    DEPARTMENT STRING,
    BRAND_ACCESS STRING,
    IS_ACTIVE BOOLEAN DEFAULT TRUE,
    PASSWORD STRING
);

-- Audit Table (The new schema)
CREATE OR REPLACE TABLE AUDIT_LOGS (
    AUDIT_ID INT AUTOINCREMENT,
    ACTION_TYPE STRING,
    ACTION_DETAILS STRING,
    ACTION_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    CHANGED_BY STRING,
    HOST_IP STRING,
    HOST_NAME STRING
);



SELECT EMAIL, PASSWORD, IS_ACTIVE 
FROM DIM_USERS 
WHERE LOWER(EMAIL) = LOWER('dubeyabhay430@gmail.com');







-- 1. Ensure the user exists
MERGE INTO DIM_USERS AS target
USING (SELECT 'EMP01' as ID, 'Abhay Dubey' as NAME, 'dubeyabhay430@gmail.com' as EMAIL, 'Abhay@2004' as PW) AS src
ON target.EMAIL = src.EMAIL
WHEN NOT MATCHED THEN INSERT (USER_ID, FULL_NAME, EMAIL, PASSWORD, IS_ACTIVE) VALUES (src.ID, src.NAME, src.EMAIL, src.PW, TRUE)
WHEN MATCHED THEN UPDATE SET PASSWORD = src.PW, IS_ACTIVE = TRUE;

-- 2. Ensure a role is mapped (Crucial for the JOIN)
INSERT INTO USER_ROLE_MAPPING (USER_ID, ROLE_NAME) 
SELECT 'EMP01', 'SUPER_ADMIN'
WHERE NOT EXISTS (SELECT 1 FROM USER_ROLE_MAPPING WHERE USER_ID = 'EMP01');



SELECT * FROM DIM_USERS;



CREATE TABLE IF NOT EXISTS USER_ROLE_MAPPING (
    USER_ID STRING,
    ROLE_NAME STRING,
    FOREIGN KEY (USER_ID) REFERENCES DIM_USERS(USER_ID),
    FOREIGN KEY (ROLE_NAME) REFERENCES DIM_ROLES(ROLE_NAME)
);




INSERT INTO USER_ROLE_MAPPING (USER_ID, ROLE_NAME)
SELECT USER_ID, 'VIEWER' 
FROM DIM_USERS 
WHERE USER_ID NOT IN (SELECT USER_ID FROM USER_ROLE_MAPPING);






-- 1. Fix hidden spaces and ensure the user is Active
UPDATE DIM_USERS 
SET EMAIL = TRIM(EMAIL), 
    PASSWORD = TRIM(PASSWORD), 
    IS_ACTIVE = TRUE 
WHERE LOWER(EMAIL) = 'abhi12@gmail.com';

-- 2. Verify if the Role Mapping actually exists for this user
-- If this returns nothing, the login WILL fail.
SELECT * FROM USER_ROLE_MAPPING 
WHERE USER_ID = (SELECT USER_ID FROM DIM_USERS WHERE LOWER(EMAIL) = 'abhi12@gmail.com');

-- 3. If the above query was empty, run this to manually link the role:
INSERT INTO USER_ROLE_MAPPING (USER_ID, ROLE_NAME)
SELECT USER_ID, 'SUPER_ADMIN' -- Change to 'VIEWER' if needed
FROM DIM_USERS 
WHERE LOWER(EMAIL) = 'abhi12@gmail.com'
AND USER_ID NOT IN (SELECT USER_ID FROM USER_ROLE_MAPPING);

-- Fix User ID 3 specifically
INSERT INTO USER_ROLE_MAPPING (USER_ID, ROLE_NAME) 
VALUES ('3', 'SUPER_ADMIN'); -- or 'VIEWER' / 'ADMIN'

-- Fix all other 'Ghost' users at once
INSERT INTO USER_ROLE_MAPPING (USER_ID, ROLE_NAME)
SELECT USER_ID, 'VIEWER' 
FROM DIM_USERS 
WHERE USER_ID NOT IN (SELECT USER_ID FROM USER_ROLE_MAPPING);



